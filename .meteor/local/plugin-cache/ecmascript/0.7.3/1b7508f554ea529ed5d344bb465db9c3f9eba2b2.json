{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[{"source":"./accounts_client.js","imported":["AccountsClient"],"specifiers":[{"kind":"named","imported":"AccountsClient","local":"AccountsClient"}]}],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"/packages/accounts-base/localstorage_token.js","filenameRelative":"/packages/accounts-base/localstorage_token.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],null],[[],{"polyfill":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"/packages/accounts-base/localstorage_token.js.map","sourceFileName":"/packages/accounts-base/localstorage_token.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"localstorage_token"},"ignored":false,"code":"var AccountsClient = void 0;\nmodule.importSync(\"./accounts_client.js\", {\n  AccountsClient: function (v) {\n    AccountsClient = v;\n  }\n}, 0);\nvar Ap = AccountsClient.prototype; // This file deals with storing a login token and user id in the\n// browser's localStorage facility. It polls local storage every few\n// seconds to synchronize login state between multiple tabs in the same\n// browser.\n// Login with a Meteor access token. This is the only public function\n// here.\n\nMeteor.loginWithToken = function (token, callback) {\n  return Accounts.loginWithToken(token, callback);\n};\n\nAp.loginWithToken = function (token, callback) {\n  this.callLoginMethod({\n    methodArguments: [{\n      resume: token\n    }],\n    userCallback: callback\n  });\n}; // Semi-internal API. Call this function to re-enable auto login after\n// if it was disabled at startup.\n\n\nAp._enableAutoLogin = function () {\n  this._autoLoginEnabled = true;\n\n  this._pollStoredLoginToken();\n}; ///\n/// STORING\n///\n// Call this from the top level of the test file for any test that does\n// logging in and out, to protect multiple tabs running the same tests\n// simultaneously from interfering with each others' localStorage.\n\n\nAp._isolateLoginTokenForTest = function () {\n  this.LOGIN_TOKEN_KEY = this.LOGIN_TOKEN_KEY + Random.id();\n  this.USER_ID_KEY = this.USER_ID_KEY + Random.id();\n};\n\nAp._storeLoginToken = function (userId, token, tokenExpires) {\n  Meteor._localStorage.setItem(this.USER_ID_KEY, userId);\n\n  Meteor._localStorage.setItem(this.LOGIN_TOKEN_KEY, token);\n\n  if (!tokenExpires) tokenExpires = this._tokenExpiration(new Date());\n\n  Meteor._localStorage.setItem(this.LOGIN_TOKEN_EXPIRES_KEY, tokenExpires); // to ensure that the localstorage poller doesn't end up trying to\n  // connect a second time\n\n\n  this._lastLoginTokenWhenPolled = token;\n};\n\nAp._unstoreLoginToken = function () {\n  Meteor._localStorage.removeItem(this.USER_ID_KEY);\n\n  Meteor._localStorage.removeItem(this.LOGIN_TOKEN_KEY);\n\n  Meteor._localStorage.removeItem(this.LOGIN_TOKEN_EXPIRES_KEY); // to ensure that the localstorage poller doesn't end up trying to\n  // connect a second time\n\n\n  this._lastLoginTokenWhenPolled = null;\n}; // This is private, but it is exported for now because it is used by a\n// test in accounts-password.\n//\n\n\nAp._storedLoginToken = function () {\n  return Meteor._localStorage.getItem(this.LOGIN_TOKEN_KEY);\n};\n\nAp._storedLoginTokenExpires = function () {\n  return Meteor._localStorage.getItem(this.LOGIN_TOKEN_EXPIRES_KEY);\n};\n\nAp._storedUserId = function () {\n  return Meteor._localStorage.getItem(this.USER_ID_KEY);\n};\n\nAp._unstoreLoginTokenIfExpiresSoon = function () {\n  var tokenExpires = this._storedLoginTokenExpires();\n\n  if (tokenExpires && this._tokenExpiresSoon(new Date(tokenExpires))) {\n    this._unstoreLoginToken();\n  }\n}; ///\n/// AUTO-LOGIN\n///\n\n\nAp._initLocalStorage = function () {\n  var self = this; // Key names to use in localStorage\n\n  self.LOGIN_TOKEN_KEY = \"Meteor.loginToken\";\n  self.LOGIN_TOKEN_EXPIRES_KEY = \"Meteor.loginTokenExpires\";\n  self.USER_ID_KEY = \"Meteor.userId\";\n  var rootUrlPathPrefix = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n\n  if (rootUrlPathPrefix || this.connection !== Meteor.connection) {\n    // We want to keep using the same keys for existing apps that do not\n    // set a custom ROOT_URL_PATH_PREFIX, so that most users will not have\n    // to log in again after an app updates to a version of Meteor that\n    // contains this code, but it's generally preferable to namespace the\n    // keys so that connections from distinct apps to distinct DDP URLs\n    // will be distinct in Meteor._localStorage.\n    var namespace = \":\" + this.connection._stream.rawUrl;\n\n    if (rootUrlPathPrefix) {\n      namespace += \":\" + rootUrlPathPrefix;\n    }\n\n    self.LOGIN_TOKEN_KEY += namespace;\n    self.LOGIN_TOKEN_EXPIRES_KEY += namespace;\n    self.USER_ID_KEY += namespace;\n  }\n\n  if (self._autoLoginEnabled) {\n    // Immediately try to log in via local storage, so that any DDP\n    // messages are sent after we have established our user account\n    self._unstoreLoginTokenIfExpiresSoon();\n\n    var token = self._storedLoginToken();\n\n    if (token) {\n      // On startup, optimistically present us as logged in while the\n      // request is in flight. This reduces page flicker on startup.\n      var userId = self._storedUserId();\n\n      userId && self.connection.setUserId(userId);\n      self.loginWithToken(token, function (err) {\n        if (err) {\n          Meteor._debug(\"Error logging in with token: \" + err);\n\n          self.makeClientLoggedOut();\n        }\n\n        self._pageLoadLogin({\n          type: \"resume\",\n          allowed: !err,\n          error: err,\n          methodName: \"login\",\n          // XXX This is duplicate code with loginWithToken, but\n          // loginWithToken can also be called at other times besides\n          // page load.\n          methodArguments: [{\n            resume: token\n          }]\n        });\n      });\n    }\n  } // Poll local storage every 3 seconds to login if someone logged in in\n  // another tab\n\n\n  self._lastLoginTokenWhenPolled = token;\n\n  if (self._pollIntervalTimer) {\n    // Unlikely that _initLocalStorage will be called more than once for\n    // the same AccountsClient instance, but just in case...\n    clearInterval(self._pollIntervalTimer);\n  }\n\n  self._pollIntervalTimer = setInterval(function () {\n    self._pollStoredLoginToken();\n  }, 3000);\n};\n\nAp._pollStoredLoginToken = function () {\n  var self = this;\n\n  if (!self._autoLoginEnabled) {\n    return;\n  }\n\n  var currentLoginToken = self._storedLoginToken(); // != instead of !== just to make sure undefined and null are treated the same\n\n\n  if (self._lastLoginTokenWhenPolled != currentLoginToken) {\n    if (currentLoginToken) {\n      self.loginWithToken(currentLoginToken, function (err) {\n        if (err) {\n          self.makeClientLoggedOut();\n        }\n      });\n    } else {\n      self.logout();\n    }\n  }\n\n  self._lastLoginTokenWhenPolled = currentLoginToken;\n};","map":{"version":3,"sources":["/packages/accounts-base/localstorage_token.js"],"names":["AccountsClient","module","importSync","v","Ap","prototype","Meteor","loginWithToken","token","callback","Accounts","callLoginMethod","methodArguments","resume","userCallback","_enableAutoLogin","_autoLoginEnabled","_pollStoredLoginToken","_isolateLoginTokenForTest","LOGIN_TOKEN_KEY","Random","id","USER_ID_KEY","_storeLoginToken","userId","tokenExpires","_localStorage","setItem","_tokenExpiration","Date","LOGIN_TOKEN_EXPIRES_KEY","_lastLoginTokenWhenPolled","_unstoreLoginToken","removeItem","_storedLoginToken","getItem","_storedLoginTokenExpires","_storedUserId","_unstoreLoginTokenIfExpiresSoon","_tokenExpiresSoon","_initLocalStorage","self","rootUrlPathPrefix","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","connection","namespace","_stream","rawUrl","setUserId","err","_debug","makeClientLoggedOut","_pageLoadLogin","type","allowed","error","methodName","_pollIntervalTimer","clearInterval","setInterval","currentLoginToken","logout"],"mappings":"AAAA,IAAIA,uBAAJ;AAAmBC,OAAOC,UAAP,CAAkB,sBAAlB,EAAyC;AAACF,kBAAe,UAASG,CAAT,EAAW;AAACH,qBAAeG,CAAf;AAAiB;AAA7C,CAAzC,EAAwF,CAAxF;AACnB,IAAIC,KAAKJ,eAAeK,SAAxB,C,CAEA;AACA;AACA;AACA;AAEA;AACA;;AACAC,OAAOC,cAAP,GAAwB,UAAUC,KAAV,EAAiBC,QAAjB,EAA2B;AACjD,SAAOC,SAASH,cAAT,CAAwBC,KAAxB,EAA+BC,QAA/B,CAAP;AACD,CAFD;;AAIAL,GAAGG,cAAH,GAAoB,UAAUC,KAAV,EAAiBC,QAAjB,EAA2B;AAC7C,OAAKE,eAAL,CAAqB;AACnBC,qBAAiB,CAAC;AAChBC,cAAQL;AADQ,KAAD,CADE;AAInBM,kBAAcL;AAJK,GAArB;AAMD,CAPD,C,CASA;AACA;;;AACAL,GAAGW,gBAAH,GAAsB,YAAY;AAChC,OAAKC,iBAAL,GAAyB,IAAzB;;AACA,OAAKC,qBAAL;AACD,CAHD,C,CAMA;AACA;AACA;AAEA;AACA;AACA;;;AACAb,GAAGc,yBAAH,GAA+B,YAAY;AACzC,OAAKC,eAAL,GAAuB,KAAKA,eAAL,GAAuBC,OAAOC,EAAP,EAA9C;AACA,OAAKC,WAAL,GAAmB,KAAKA,WAAL,GAAmBF,OAAOC,EAAP,EAAtC;AACD,CAHD;;AAKAjB,GAAGmB,gBAAH,GAAsB,UAAUC,MAAV,EAAkBhB,KAAlB,EAAyBiB,YAAzB,EAAuC;AAC3DnB,SAAOoB,aAAP,CAAqBC,OAArB,CAA6B,KAAKL,WAAlC,EAA+CE,MAA/C;;AACAlB,SAAOoB,aAAP,CAAqBC,OAArB,CAA6B,KAAKR,eAAlC,EAAmDX,KAAnD;;AACA,MAAI,CAAEiB,YAAN,EACEA,eAAe,KAAKG,gBAAL,CAAsB,IAAIC,IAAJ,EAAtB,CAAf;;AACFvB,SAAOoB,aAAP,CAAqBC,OAArB,CAA6B,KAAKG,uBAAlC,EAA2DL,YAA3D,EAL2D,CAO3D;AACA;;;AACA,OAAKM,yBAAL,GAAiCvB,KAAjC;AACD,CAVD;;AAYAJ,GAAG4B,kBAAH,GAAwB,YAAY;AAClC1B,SAAOoB,aAAP,CAAqBO,UAArB,CAAgC,KAAKX,WAArC;;AACAhB,SAAOoB,aAAP,CAAqBO,UAArB,CAAgC,KAAKd,eAArC;;AACAb,SAAOoB,aAAP,CAAqBO,UAArB,CAAgC,KAAKH,uBAArC,EAHkC,CAKlC;AACA;;;AACA,OAAKC,yBAAL,GAAiC,IAAjC;AACD,CARD,C,CAUA;AACA;AACA;;;AACA3B,GAAG8B,iBAAH,GAAuB,YAAY;AACjC,SAAO5B,OAAOoB,aAAP,CAAqBS,OAArB,CAA6B,KAAKhB,eAAlC,CAAP;AACD,CAFD;;AAIAf,GAAGgC,wBAAH,GAA8B,YAAY;AACxC,SAAO9B,OAAOoB,aAAP,CAAqBS,OAArB,CAA6B,KAAKL,uBAAlC,CAAP;AACD,CAFD;;AAIA1B,GAAGiC,aAAH,GAAmB,YAAY;AAC7B,SAAO/B,OAAOoB,aAAP,CAAqBS,OAArB,CAA6B,KAAKb,WAAlC,CAAP;AACD,CAFD;;AAIAlB,GAAGkC,+BAAH,GAAqC,YAAY;AAC/C,MAAIb,eAAe,KAAKW,wBAAL,EAAnB;;AACA,MAAIX,gBAAgB,KAAKc,iBAAL,CAAuB,IAAIV,IAAJ,CAASJ,YAAT,CAAvB,CAApB,EAAoE;AAClE,SAAKO,kBAAL;AACD;AACF,CALD,C,CAOA;AACA;AACA;;;AAEA5B,GAAGoC,iBAAH,GAAuB,YAAY;AACjC,MAAIC,OAAO,IAAX,CADiC,CAGjC;;AACAA,OAAKtB,eAAL,GAAuB,mBAAvB;AACAsB,OAAKX,uBAAL,GAA+B,0BAA/B;AACAW,OAAKnB,WAAL,GAAmB,eAAnB;AAEA,MAAIoB,oBAAoBC,0BAA0BC,oBAAlD;;AACA,MAAIF,qBAAqB,KAAKG,UAAL,KAAoBvC,OAAOuC,UAApD,EAAgE;AAC9D;AACA;AACA;AACA;AACA;AACA;AACA,QAAIC,YAAY,MAAM,KAAKD,UAAL,CAAgBE,OAAhB,CAAwBC,MAA9C;;AACA,QAAIN,iBAAJ,EAAuB;AACrBI,mBAAa,MAAMJ,iBAAnB;AACD;;AACDD,SAAKtB,eAAL,IAAwB2B,SAAxB;AACAL,SAAKX,uBAAL,IAAgCgB,SAAhC;AACAL,SAAKnB,WAAL,IAAoBwB,SAApB;AACD;;AAED,MAAIL,KAAKzB,iBAAT,EAA4B;AAC1B;AACA;AACAyB,SAAKH,+BAAL;;AACA,QAAI9B,QAAQiC,KAAKP,iBAAL,EAAZ;;AACA,QAAI1B,KAAJ,EAAW;AACT;AACA;AACA,UAAIgB,SAASiB,KAAKJ,aAAL,EAAb;;AACAb,gBAAUiB,KAAKI,UAAL,CAAgBI,SAAhB,CAA0BzB,MAA1B,CAAV;AACAiB,WAAKlC,cAAL,CAAoBC,KAApB,EAA2B,UAAU0C,GAAV,EAAe;AACxC,YAAIA,GAAJ,EAAS;AACP5C,iBAAO6C,MAAP,CAAc,kCAAkCD,GAAhD;;AACAT,eAAKW,mBAAL;AACD;;AAEDX,aAAKY,cAAL,CAAoB;AAClBC,gBAAM,QADY;AAElBC,mBAAS,CAACL,GAFQ;AAGlBM,iBAAON,GAHW;AAIlBO,sBAAY,OAJM;AAKlB;AACA;AACA;AACA7C,2BAAiB,CAAC;AAACC,oBAAQL;AAAT,WAAD;AARC,SAApB;AAUD,OAhBD;AAiBD;AACF,GArDgC,CAuDjC;AACA;;;AACAiC,OAAKV,yBAAL,GAAiCvB,KAAjC;;AAEA,MAAIiC,KAAKiB,kBAAT,EAA6B;AAC3B;AACA;AACAC,kBAAclB,KAAKiB,kBAAnB;AACD;;AAEDjB,OAAKiB,kBAAL,GAA0BE,YAAY,YAAY;AAChDnB,SAAKxB,qBAAL;AACD,GAFyB,EAEvB,IAFuB,CAA1B;AAGD,CApED;;AAsEAb,GAAGa,qBAAH,GAA2B,YAAY;AACrC,MAAIwB,OAAO,IAAX;;AAEA,MAAI,CAAEA,KAAKzB,iBAAX,EAA8B;AAC5B;AACD;;AAED,MAAI6C,oBAAoBpB,KAAKP,iBAAL,EAAxB,CAPqC,CASrC;;;AACA,MAAIO,KAAKV,yBAAL,IAAkC8B,iBAAtC,EAAyD;AACvD,QAAIA,iBAAJ,EAAuB;AACrBpB,WAAKlC,cAAL,CAAoBsD,iBAApB,EAAuC,UAAUX,GAAV,EAAe;AACpD,YAAIA,GAAJ,EAAS;AACPT,eAAKW,mBAAL;AACD;AACF,OAJD;AAKD,KAND,MAMO;AACLX,WAAKqB,MAAL;AACD;AACF;;AAEDrB,OAAKV,yBAAL,GAAiC8B,iBAAjC;AACD,CAvBD","file":"/packages/accounts-base/localstorage_token.js.map","sourcesContent":["import {AccountsClient} from \"./accounts_client.js\";\nvar Ap = AccountsClient.prototype;\n\n// This file deals with storing a login token and user id in the\n// browser's localStorage facility. It polls local storage every few\n// seconds to synchronize login state between multiple tabs in the same\n// browser.\n\n// Login with a Meteor access token. This is the only public function\n// here.\nMeteor.loginWithToken = function (token, callback) {\n  return Accounts.loginWithToken(token, callback);\n};\n\nAp.loginWithToken = function (token, callback) {\n  this.callLoginMethod({\n    methodArguments: [{\n      resume: token\n    }],\n    userCallback: callback\n  });\n};\n\n// Semi-internal API. Call this function to re-enable auto login after\n// if it was disabled at startup.\nAp._enableAutoLogin = function () {\n  this._autoLoginEnabled = true;\n  this._pollStoredLoginToken();\n};\n\n\n///\n/// STORING\n///\n\n// Call this from the top level of the test file for any test that does\n// logging in and out, to protect multiple tabs running the same tests\n// simultaneously from interfering with each others' localStorage.\nAp._isolateLoginTokenForTest = function () {\n  this.LOGIN_TOKEN_KEY = this.LOGIN_TOKEN_KEY + Random.id();\n  this.USER_ID_KEY = this.USER_ID_KEY + Random.id();\n};\n\nAp._storeLoginToken = function (userId, token, tokenExpires) {\n  Meteor._localStorage.setItem(this.USER_ID_KEY, userId);\n  Meteor._localStorage.setItem(this.LOGIN_TOKEN_KEY, token);\n  if (! tokenExpires)\n    tokenExpires = this._tokenExpiration(new Date());\n  Meteor._localStorage.setItem(this.LOGIN_TOKEN_EXPIRES_KEY, tokenExpires);\n\n  // to ensure that the localstorage poller doesn't end up trying to\n  // connect a second time\n  this._lastLoginTokenWhenPolled = token;\n};\n\nAp._unstoreLoginToken = function () {\n  Meteor._localStorage.removeItem(this.USER_ID_KEY);\n  Meteor._localStorage.removeItem(this.LOGIN_TOKEN_KEY);\n  Meteor._localStorage.removeItem(this.LOGIN_TOKEN_EXPIRES_KEY);\n\n  // to ensure that the localstorage poller doesn't end up trying to\n  // connect a second time\n  this._lastLoginTokenWhenPolled = null;\n};\n\n// This is private, but it is exported for now because it is used by a\n// test in accounts-password.\n//\nAp._storedLoginToken = function () {\n  return Meteor._localStorage.getItem(this.LOGIN_TOKEN_KEY);\n};\n\nAp._storedLoginTokenExpires = function () {\n  return Meteor._localStorage.getItem(this.LOGIN_TOKEN_EXPIRES_KEY);\n};\n\nAp._storedUserId = function () {\n  return Meteor._localStorage.getItem(this.USER_ID_KEY);\n};\n\nAp._unstoreLoginTokenIfExpiresSoon = function () {\n  var tokenExpires = this._storedLoginTokenExpires();\n  if (tokenExpires && this._tokenExpiresSoon(new Date(tokenExpires))) {\n    this._unstoreLoginToken();\n  }\n};\n\n///\n/// AUTO-LOGIN\n///\n\nAp._initLocalStorage = function () {\n  var self = this;\n\n  // Key names to use in localStorage\n  self.LOGIN_TOKEN_KEY = \"Meteor.loginToken\";\n  self.LOGIN_TOKEN_EXPIRES_KEY = \"Meteor.loginTokenExpires\";\n  self.USER_ID_KEY = \"Meteor.userId\";\n\n  var rootUrlPathPrefix = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n  if (rootUrlPathPrefix || this.connection !== Meteor.connection) {\n    // We want to keep using the same keys for existing apps that do not\n    // set a custom ROOT_URL_PATH_PREFIX, so that most users will not have\n    // to log in again after an app updates to a version of Meteor that\n    // contains this code, but it's generally preferable to namespace the\n    // keys so that connections from distinct apps to distinct DDP URLs\n    // will be distinct in Meteor._localStorage.\n    var namespace = \":\" + this.connection._stream.rawUrl;\n    if (rootUrlPathPrefix) {\n      namespace += \":\" + rootUrlPathPrefix;\n    }\n    self.LOGIN_TOKEN_KEY += namespace;\n    self.LOGIN_TOKEN_EXPIRES_KEY += namespace;\n    self.USER_ID_KEY += namespace;\n  }\n\n  if (self._autoLoginEnabled) {\n    // Immediately try to log in via local storage, so that any DDP\n    // messages are sent after we have established our user account\n    self._unstoreLoginTokenIfExpiresSoon();\n    var token = self._storedLoginToken();\n    if (token) {\n      // On startup, optimistically present us as logged in while the\n      // request is in flight. This reduces page flicker on startup.\n      var userId = self._storedUserId();\n      userId && self.connection.setUserId(userId);\n      self.loginWithToken(token, function (err) {\n        if (err) {\n          Meteor._debug(\"Error logging in with token: \" + err);\n          self.makeClientLoggedOut();\n        }\n\n        self._pageLoadLogin({\n          type: \"resume\",\n          allowed: !err,\n          error: err,\n          methodName: \"login\",\n          // XXX This is duplicate code with loginWithToken, but\n          // loginWithToken can also be called at other times besides\n          // page load.\n          methodArguments: [{resume: token}]\n        });\n      });\n    }\n  }\n\n  // Poll local storage every 3 seconds to login if someone logged in in\n  // another tab\n  self._lastLoginTokenWhenPolled = token;\n\n  if (self._pollIntervalTimer) {\n    // Unlikely that _initLocalStorage will be called more than once for\n    // the same AccountsClient instance, but just in case...\n    clearInterval(self._pollIntervalTimer);\n  }\n\n  self._pollIntervalTimer = setInterval(function () {\n    self._pollStoredLoginToken();\n  }, 3000);\n};\n\nAp._pollStoredLoginToken = function () {\n  var self = this;\n\n  if (! self._autoLoginEnabled) {\n    return;\n  }\n\n  var currentLoginToken = self._storedLoginToken();\n\n  // != instead of !== just to make sure undefined and null are treated the same\n  if (self._lastLoginTokenWhenPolled != currentLoginToken) {\n    if (currentLoginToken) {\n      self.loginWithToken(currentLoginToken, function (err) {\n        if (err) {\n          self.makeClientLoggedOut();\n        }\n      });\n    } else {\n      self.logout();\n    }\n  }\n\n  self._lastLoginTokenWhenPolled = currentLoginToken;\n};\n"]},"hash":"1b7508f554ea529ed5d344bb465db9c3f9eba2b2"}
